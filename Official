-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Camera = game:GetService("Workspace").CurrentCamera

-- Variables
local localPlayer = Players.LocalPlayer
local mouse = localPlayer:GetMouse()
local aimlockEnabled = false
local espEnabled = false

-- GUI Creation
local ScreenGui = Instance.new("ScreenGui", localPlayer:WaitForChild("PlayerGui"))
ScreenGui.Name = "HeisenHub"
ScreenGui.ResetOnSpawn = false  -- Ensure GUI stays on screen after death

local Frame = Instance.new("Frame", ScreenGui)
Frame.Size = UDim2.new(0, 300, 0, 400)  -- Adjusted size
Frame.Position = UDim2.new(0.5, -150, 0.5, -200)
Frame.BackgroundColor3 = Color3.new(0, 0, 0)
Frame.BackgroundTransparency = 0.5
Frame.Active = true
Frame.Draggable = true

local Header = Instance.new("TextLabel", Frame)
Header.Size = UDim2.new(1, 0, 0, 50)
Header.Position = UDim2.new(0, 0, 0, 0)
Header.Text = "HeisenHub"
Header.TextColor3 = Color3.new(1, 1, 1)
Header.BackgroundColor3 = Color3.new(0.1, 0.1, 0.1)

local Divider = Instance.new("Frame", Frame)
Divider.Size = UDim2.new(1, 0, 0, 2)
Divider.Position = UDim2.new(0, 0, 0, 50)
Divider.BackgroundColor3 = Color3.new(0.5, 0.5, 0.5)

local AimlockButton = Instance.new("TextButton", Frame)
AimlockButton.Size = UDim2.new(0, 280, 0, 50)
AimlockButton.Position = UDim2.new(0, 10, 0, 60)
AimlockButton.Text = "Toggle Aimlock (Off)"
AimlockButton.TextColor3 = Color3.new(1, 1, 1)
AimlockButton.BackgroundColor3 = Color3.new(0.2, 0.2, 0.2)
AimlockButton.MouseButton1Click:Connect(function()
    aimlockEnabled = not aimlockEnabled
    AimlockButton.Text = "Toggle Aimlock (" .. (aimlockEnabled and "On" or "Off") .. ")"
end)

local BodyPartDropdown = Instance.new("TextButton", Frame)
BodyPartDropdown.Size = UDim2.new(0, 280, 0, 50)
BodyPartDropdown.Position = UDim2.new(0, 10, 0, 120)
BodyPartDropdown.Text = "Select Body Part (Head)"
BodyPartDropdown.TextColor3 = Color3.new(1, 1, 1)
BodyPartDropdown.BackgroundColor3 = Color3.new(0.2, 0.2, 0.2)

local BodyPartList = {"Head", "Torso", "LeftArm", "RightArm", "LeftLeg", "RightLeg"}
local selectedBodyPart = "Head"

BodyPartDropdown.MouseButton1Click:Connect(function()
    local currentIndex = table.find(BodyPartList, selectedBodyPart)
    local nextIndex = currentIndex % #BodyPartList + 1
    selectedBodyPart = BodyPartList[nextIndex]
    BodyPartDropdown.Text = "Select Body Part (" .. selectedBodyPart .. ")"
end)

local ESPButton = Instance.new("TextButton", Frame)
ESPButton.Size = UDim2.new(0, 280, 0, 50)
ESPButton.Position = UDim2.new(0, 10, 0, 180)
ESPButton.Text = "Toggle ESP (Off)"
ESPButton.TextColor3 = Color3.new(1, 1, 1)
ESPButton.BackgroundColor3 = Color3.new(0.2, 0.2, 0.2)
ESPButton.MouseButton1Click:Connect(function()
    espEnabled = not espEnabled
    ESPButton.Text = "Toggle ESP (" .. (espEnabled and "On" or "Off") .. ")"
end)

local InfoFrame = Instance.new("Frame", ScreenGui)
InfoFrame.Size = UDim2.new(0, 200, 0, 150)
InfoFrame.Position = UDim2.new(1, -210, 1, -160)  -- Bottom right corner
InfoFrame.BackgroundColor3 = Color3.new(0, 0, 0)
InfoFrame.BackgroundTransparency = 0.5
InfoFrame.Visible = false

local InfoLabel = Instance.new("TextLabel", InfoFrame)
InfoLabel.Size = UDim2.new(0, 180, 0, 130)
InfoLabel.Position = UDim2.new(0, 10, 0, 10)
InfoLabel.TextColor3 = Color3.new(1, 1, 1)
InfoLabel.BackgroundTransparency = 1

-- Hide GUI with Right CTRL
UserInputService.InputBegan:Connect(function(input)
    if input.KeyCode == Enum.KeyCode.RightControl then
        ScreenGui.Enabled = not ScreenGui.Enabled
    end
end)

-- Functions
local function isTargetVisible(target)
    local origin = Camera.CFrame.Position
    local direction = (target.Position - origin).unit * (target.Position - origin).magnitude
    local raycastParams = RaycastParams.new()
    raycastParams.FilterType = Enum.RaycastFilterType.Blacklist
    raycastParams.FilterDescendantsInstances = {localPlayer.Character}

    local raycastResult = workspace:Raycast(origin, direction, raycastParams)
    if raycastResult and raycastResult.Instance then
        return raycastResult.Instance:IsDescendantOf(target.Parent)
    end
    return false
end

local function getTarget()
    local closestPlayer = nil
    local shortestDistance = math.huge

    for _, player in pairs(Players:GetPlayers()) do
        if player ~= localPlayer and player.Character and player.Character:FindFirstChild(selectedBodyPart) then
            local distance = (player.Character[selectedBodyPart].Position - localPlayer.Character.Head.Position).magnitude
            if distance < shortestDistance and isTargetVisible(player.Character[selectedBodyPart]) then
                closestPlayer = player
                shortestDistance = distance
            end
        end
    end

    return closestPlayer
end

local function aimAt(target)
    local camera = workspace.CurrentCamera
    camera.CFrame = CFrame.new(camera.CFrame.Position, target.Position)
end

local function createESP(player)
    local highlight = Instance.new("Highlight", player.Character)
    highlight.FillColor = Color3.new(1, 0, 0)
    highlight.OutlineColor = Color3.new(1, 0, 0)
    highlight.FillTransparency = 0.5
    highlight.OutlineTransparency = 0
end

local function removeESP(player)
    for _, highlight in pairs(player.Character:GetChildren()) do
        if highlight:IsA("Highlight") then
            highlight:Destroy()
        end
    end
end

local function updateInfoFrame(player)
    if player and player.Character and player.Character:FindFirstChild(selectedBodyPart) then
        local distance = (player.Character[selectedBodyPart].Position - localPlayer.Character.Head.Position).magnitude
        local health = player.Character:FindFirstChildOfClass("Humanoid") and player.Character:FindFirstChildOfClass("Humanoid").Health or 0

        InfoLabel.Text = "Username: " .. player.Name .. "\n"
                        .. "Health: " .. math.floor(health) .. "\n"
                        .. "Distance: " .. math.floor(distance)
        InfoFrame.Visible = true
    else
        InfoFrame.Visible = false
    end
end

-- Main Loop
RunService.RenderStepped:Connect(function()
    if aimlockEnabled then
        local currentTarget = getTarget()
        if currentTarget and currentTarget.Character and currentTarget.Character:FindFirstChild(selectedBodyPart) then
            aimAt(currentTarget.Character[selectedBodyPart])
        end
    end

    if espEnabled then
        for _, player in pairs(Players:GetPlayers()) do
            if player ~= localPlayer and player.Character then
                if not player.Character:FindFirstChildOfClass("Highlight") then
                    createESP(player)
                end
                updateInfoFrame(getTarget())
            end
        end
    else
        for _, player in pairs(Players:GetPlayers()) do
            if player.Character and player.Character:FindFirstChildOfClass("Highlight") then
                removeESP(player)
            end
        end
        InfoFrame.Visible = false
    end
end)
