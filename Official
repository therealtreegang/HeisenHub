-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Camera = game:GetService("Workspace").CurrentCamera

-- Variables
local localPlayer = Players.LocalPlayer
local mouse = localPlayer:GetMouse()
local aimlockEnabled = false
local espEnabled = false
local walkSpeed = 16 -- Default Roblox walkspeed

-- GUI Creation
local ScreenGui = Instance.new("ScreenGui", localPlayer:WaitForChild("PlayerGui"))
ScreenGui.Name = "HeisenHub"

local Frame = Instance.new("Frame", ScreenGui)
Frame.Size = UDim2.new(0, 200, 0, 400)
Frame.Position = UDim2.new(0.5, -100, 0.5, -200)
Frame.BackgroundColor3 = Color3.new(0, 0, 0)
Frame.BackgroundTransparency = 0.5
Frame.Active = true
Frame.Draggable = true

local AimlockButton = Instance.new("TextButton", Frame)
AimlockButton.Size = UDim2.new(0, 180, 0, 50)
AimlockButton.Position = UDim2.new(0, 10, 0, 10)
AimlockButton.Text = "Toggle Aimlock (Off)"
AimlockButton.TextColor3 = Color3.new(1, 1, 1)
AimlockButton.BackgroundColor3 = Color3.new(0.2, 0.2, 0.2)
AimlockButton.MouseButton1Click:Connect(function()
    aimlockEnabled = not aimlockEnabled
    AimlockButton.Text = "Toggle Aimlock (" .. (aimlockEnabled and "On" or "Off") .. ")"
end)

local ESPButton = Instance.new("TextButton", Frame)
ESPButton.Size = UDim2.new(0, 180, 0, 50)
ESPButton.Position = UDim2.new(0, 10, 0, 70)
ESPButton.Text = "Toggle ESP (Off)"
ESPButton.TextColor3 = Color3.new(1, 1, 1)
ESPButton.BackgroundColor3 = Color3.new(0.2, 0.2, 0.2)
ESPButton.MouseButton1Click:Connect(function()
    espEnabled = not espEnabled
    ESPButton.Text = "Toggle ESP (" .. (espEnabled and "On" or "Off") .. ")"
end)

local WalkSpeedSliderLabel = Instance.new("TextLabel", Frame)
WalkSpeedSliderLabel.Size = UDim2.new(0, 180, 0, 50)
WalkSpeedSliderLabel.Position = UDim2.new(0, 10, 0, 130)
WalkSpeedSliderLabel.Text = "Walk Speed"
WalkSpeedSliderLabel.TextColor3 = Color3.new(1, 1, 1)
WalkSpeedSliderLabel.BackgroundColor3 = Color3.new(0.2, 0.2, 0.2)

local WalkSpeedSlider = Instance.new("TextButton", Frame)
WalkSpeedSlider.Size = UDim2.new(0, 180, 0, 50)
WalkSpeedSlider.Position = UDim2.new(0, 10, 0, 190)
WalkSpeedSlider.Text = "Set Walk Speed (16)"
WalkSpeedSlider.TextColor3 = Color3.new(1, 1, 1)
WalkSpeedSlider.BackgroundColor3 = Color3.new(0.2, 0.2, 0.2)
WalkSpeedSlider.MouseButton1Click:Connect(function()
    local input = tonumber(game:GetService("Players").LocalPlayer.PlayerGui:WaitForChild("ScreenGui"):WaitForChild("Frame"):WaitForChild("WalkSpeedInputBox").Text)
    if input and input >= 16 and input <= 100 then
        walkSpeed = input
        localPlayer.Character.Humanoid.WalkSpeed = walkSpeed
        WalkSpeedSlider.Text = "Set Walk Speed (" .. tostring(walkSpeed) .. ")"
    end
end)

local WalkSpeedInputBox = Instance.new("TextBox", Frame)
WalkSpeedInputBox.Size = UDim2.new(0, 180, 0, 50)
WalkSpeedInputBox.Position = UDim2.new(0, 10, 0, 250)
WalkSpeedInputBox.Text = "Enter speed between 16 and 100"
WalkSpeedInputBox.TextColor3 = Color3.new(1, 1, 1)
WalkSpeedInputBox.BackgroundColor3 = Color3.new(0.2, 0.2, 0.2)
WalkSpeedInputBox.FocusLost:Connect(function()
    local input = tonumber(WalkSpeedInputBox.Text)
    if input and input >= 16 and input <= 100 then
        walkSpeed = input
        localPlayer.Character.Humanoid.WalkSpeed = walkSpeed
        WalkSpeedSlider.Text = "Set Walk Speed (" .. tostring(walkSpeed) .. ")"
    else
        WalkSpeedInputBox.Text = "Invalid speed! 16-100"
    end
end)

local InfoFrame = Instance.new("Frame", ScreenGui)
InfoFrame.Size = UDim2.new(0, 200, 0, 150)
InfoFrame.Position = UDim2.new(1, -210, 0, 10)
InfoFrame.BackgroundColor3 = Color3.new(0, 0, 0)
InfoFrame.BackgroundTransparency = 0.5
InfoFrame.Visible = false

local InfoLabel = Instance.new("TextLabel", InfoFrame)
InfoLabel.Size = UDim2.new(0, 180, 0, 130)
InfoLabel.Position = UDim2.new(0, 10, 0, 10)
InfoLabel.TextColor3 = Color3.new(1, 1, 1)
InfoLabel.BackgroundTransparency = 1

-- Hide GUI with Right CTRL
UserInputService.InputBegan:Connect(function(input)
    if input.KeyCode == Enum.KeyCode.RightControl then
        ScreenGui.Enabled = not ScreenGui.Enabled
    end
end)

-- Functions
local function isTargetVisible(target)
    local origin = Camera.CFrame.Position
    local direction = (target.Position - origin).unit * (target.Position - origin).magnitude
    local raycastParams = RaycastParams.new()
    raycastParams.FilterType = Enum.RaycastFilterType.Blacklist
    raycastParams.FilterDescendantsInstances = {localPlayer.Character}

    local raycastResult = workspace:Raycast(origin, direction, raycastParams)
    if raycastResult and raycastResult.Instance then
        return raycastResult.Instance:IsDescendantOf(target.Parent)
    end
    return false
end

local function getTarget()
    local closestPlayer = nil
    local shortestDistance = math.huge

    for _, player in pairs(Players:GetPlayers()) do
        if player ~= localPlayer and player.Character and player.Character:FindFirstChild("Head") then
            local distance = (player.Character.Head.Position - localPlayer.Character.Head.Position).magnitude
            if distance < shortestDistance and isTargetVisible(player.Character.Head) then
                closestPlayer = player
                shortestDistance = distance
            end
        end
    end

    return closestPlayer
end

local function aimAt(target)
    local camera = workspace.CurrentCamera
    camera.CFrame = CFrame.new(camera.CFrame.Position, target.Position)
end

local function createESP(player)
    local highlight = Instance.new("Highlight", player.Character)
    highlight.FillColor = Color3.new(1, 0, 0)
    highlight.OutlineColor = Color3.new(1, 0, 0)
    highlight.FillTransparency = 0.5
    highlight.OutlineTransparency = 0
end

local function removeESP(player)
    for _, highlight in pairs(player.Character:GetChildren()) do
        if highlight:IsA("Highlight") then
            highlight:Destroy()
        end
    end
end

local function updateInfoFrame(player)
    if player and player.Character and player.Character:FindFirstChild("Head") then
        local distance = (player.Character.Head.Position - localPlayer.Character.Head.Position).magnitude
        local health = player.Character:FindFirstChildOfClass("Humanoid") and player.Character:FindFirstChildOfClass("Humanoid").Health or 0
        local avatar = player.Character.Head:Clone()
        avatar.Size = UDim2.new(0, 50, 0, 50)
        avatar.Parent = InfoFrame

        InfoLabel.Text = "Username: " .. player.Name .. "\n"
                        .. "Health: " .. math.floor(health) .. "\n"
                        .. "Distance: " .. math.floor(distance)
        InfoFrame.Visible = true
    else
        InfoFrame.Visible = false
    end
end

-- Main Loop
RunService.RenderStepped:Connect(function()
    if aimlockEnabled then
        local currentTarget = getTarget()
        if currentTarget and currentTarget.Character and currentTarget.Character:FindFirstChild("Head") then
            aimAt(currentTarget.Character.Head)
        end
    end

    if espEnabled then
        for _, player in pairs(Players:GetPlayers()) do
            if player ~= localPlayer and player.Character then
                if not player.Character:FindFirstChildOfClass("Highlight") then
                    createESP(player)
                end
                updateInfoFrame(getTarget())
            end
        end
    else
        for _, player in pairs(Players:GetPlayers()) do
            if player.Character and player.Character:FindFirstChildOfClass("Highlight") then
                removeESP(player)
            end
        end
        InfoFrame.Visible = false
    end
end)
